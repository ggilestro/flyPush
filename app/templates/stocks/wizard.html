{% extends "base.html" %}

{% block content %}
<div class="mb-6">
    <nav class="flex" aria-label="Breadcrumb">
        <ol class="flex items-center space-x-2">
            <li><a href="/stocks" class="text-gray-500 hover:text-gray-700">Stocks</a></li>
            <li class="flex items-center">
                <svg class="h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                </svg>
                <span class="ml-2 text-gray-900 font-medium">Add Stock (Guided)</span>
            </li>
        </ol>
    </nav>
    <h1 class="mt-4 text-2xl font-semibold text-gray-900">Add New Stock</h1>
    <p class="mt-1 text-sm text-gray-500">Follow the steps below to add a stock to your collection</p>
</div>

<div id="wizard-message"></div>

<div x-data="stockWizard()" x-init="loadStats()">
    <!-- Step Indicator -->
    <div class="mb-8">
        <nav aria-label="Progress">
            <ol class="flex items-center">
                <template x-for="(s, i) in steps" :key="i">
                    <li class="flex items-center" :class="i < steps.length - 1 ? 'flex-1' : ''">
                        <div class="flex items-center" :class="i > 0 ? 'ml-2' : ''">
                            <!-- Completed step -->
                            <template x-if="step > i + 1">
                                <div class="flex items-center">
                                    <span class="flex h-8 w-8 items-center justify-center rounded-full bg-primary-600">
                                        <svg class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                        </svg>
                                    </span>
                                    <span class="ml-2 text-sm font-medium text-primary-600 hidden sm:inline" x-text="s"></span>
                                </div>
                            </template>
                            <!-- Current step -->
                            <template x-if="step === i + 1">
                                <div class="flex items-center">
                                    <span class="flex h-8 w-8 items-center justify-center rounded-full border-2 border-primary-600 bg-white">
                                        <span class="text-sm font-semibold text-primary-600" x-text="i + 1"></span>
                                    </span>
                                    <span class="ml-2 text-sm font-medium text-primary-600 hidden sm:inline" x-text="s"></span>
                                </div>
                            </template>
                            <!-- Future step -->
                            <template x-if="step < i + 1">
                                <div class="flex items-center">
                                    <span class="flex h-8 w-8 items-center justify-center rounded-full border-2 border-gray-300 bg-white">
                                        <span class="text-sm font-medium text-gray-500" x-text="i + 1"></span>
                                    </span>
                                    <span class="ml-2 text-sm font-medium text-gray-500 hidden sm:inline" x-text="s"></span>
                                </div>
                            </template>
                        </div>
                        <!-- Connector line -->
                        <template x-if="i < steps.length - 1">
                            <div class="flex-1 mx-2 sm:mx-4">
                                <div class="h-0.5" :class="step > i + 1 ? 'bg-primary-600' : 'bg-gray-300'"></div>
                            </div>
                        </template>
                    </li>
                </template>
            </ol>
        </nav>
    </div>

    <!-- Step 1: Origin & FlyBase Search -->
    <div x-show="step === 1" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 translate-x-4" x-transition:enter-end="opacity-100 translate-x-0">
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-lg font-medium text-gray-900 mb-4">Where is this stock from?</h2>

            <!-- Origin Selection -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                <button type="button" @click="setFromRepository(true)"
                        :class="fromRepository === true ? 'ring-2 ring-primary-600 bg-primary-50' : 'ring-1 ring-gray-300 hover:bg-gray-50'"
                        class="relative flex flex-col items-center rounded-lg p-6 text-center transition-all">
                    <svg class="h-8 w-8 mb-2" :class="fromRepository === true ? 'text-primary-600' : 'text-gray-400'" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
                    </svg>
                    <span class="text-sm font-medium" :class="fromRepository === true ? 'text-primary-900' : 'text-gray-900'">Public Repository</span>
                    <span class="text-xs mt-1" :class="fromRepository === true ? 'text-primary-700' : 'text-gray-500'">BDSC, VDRC, Kyoto, etc.</span>
                </button>

                <button type="button" @click="setFromRepository(false)"
                        :class="fromRepository === false ? 'ring-2 ring-primary-600 bg-primary-50' : 'ring-1 ring-gray-300 hover:bg-gray-50'"
                        class="relative flex flex-col items-center rounded-lg p-6 text-center transition-all">
                    <svg class="h-8 w-8 mb-2" :class="fromRepository === false ? 'text-primary-600' : 'text-gray-400'" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                    </svg>
                    <span class="text-sm font-medium" :class="fromRepository === false ? 'text-primary-900' : 'text-gray-900'">Lab / Other Source</span>
                    <span class="text-xs mt-1" :class="fromRepository === false ? 'text-primary-700' : 'text-gray-500'">Internal, gift, other lab</span>
                </button>
            </div>

            <!-- Repository Search (if fromRepository=true) -->
            <div x-show="fromRepository === true" x-transition class="space-y-4">
                <!-- Repository Filter Pills -->
                <div x-show="stats" class="flex flex-wrap gap-2">
                    <template x-for="repo in stats?.repositories || []" :key="repo.id">
                        <button type="button" @click="selectedRepository = repo.id"
                                :class="selectedRepository === repo.id ? 'bg-primary-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                class="inline-flex items-center rounded-full px-3 py-1 text-sm font-medium transition-colors">
                            <span x-text="repo.name"></span>
                        </button>
                    </template>
                </div>

                <!-- Search Form -->
                <div class="flex gap-3">
                    <input type="text" x-model="searchQuery"
                           :placeholder="selectedRepository ? `Search ${getRepositoryName(selectedRepository)} stocks...` : 'Select a repository first'"
                           :disabled="!selectedRepository"
                           @keydown.enter.prevent="searchFlyBase()"
                           class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm px-3 py-2 border disabled:bg-gray-100 disabled:text-gray-500">
                    <button type="button" @click="searchFlyBase()"
                            :disabled="!searchQuery.trim() || !selectedRepository || searching"
                            class="inline-flex items-center rounded-md bg-primary-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500 disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg x-show="searching" class="animate-spin h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span x-text="searching ? 'Searching...' : 'Search'"></span>
                    </button>
                </div>

                <!-- Search Results -->
                <div x-show="searchResults !== null && searchResults.length > 0" class="border rounded-lg overflow-hidden">
                    <div class="max-h-64 overflow-y-auto">
                        <template x-for="result in searchResults" :key="result.external_id">
                            <button type="button" @click="selectFlyBaseResult(result)"
                                    :class="selectedResult?.external_id === result.external_id ? 'bg-primary-50 border-l-4 border-l-primary-600' : 'hover:bg-gray-50 border-l-4 border-l-transparent'"
                                    class="w-full text-left px-4 py-3 border-b border-gray-100 last:border-b-0 transition-colors">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-900" x-text="result.external_id"></span>
                                    <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-800" x-text="result.source.toUpperCase()"></span>
                                </div>
                                <div class="text-sm text-gray-600 mt-1 line-clamp-2" x-text="result.genotype"></div>
                            </button>
                        </template>
                    </div>
                </div>

                <div x-show="searchResults !== null && searchResults.length === 0" class="text-center py-6 text-sm text-gray-500">
                    No stocks found. Try a different search term.
                </div>

                <!-- Selected stock info -->
                <div x-show="selectedResult" class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="text-sm font-medium text-green-900">Selected: <span x-text="selectedResult?.external_id"></span></p>
                            <p class="text-sm text-green-700 mt-1" x-text="selectedResult?.genotype"></p>
                        </div>
                        <button type="button" @click="clearSelection()" class="text-green-600 hover:text-green-800">
                            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>

                    <!-- Genotype modified? -->
                    <div class="mt-3 border-t border-green-200 pt-3">
                        <label class="flex items-center gap-2 text-sm text-green-900">
                            <input type="checkbox" x-model="genotypeModified"
                                   class="h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                            Genotype has been modified from the original
                        </label>
                        <div x-show="genotypeModified" class="mt-2">
                            <textarea x-model="data.genotype" rows="2"
                                      class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm px-3 py-2 border"
                                      placeholder="Enter modified genotype"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manual Entry (if fromRepository=false) -->
            <div x-show="fromRepository === false" x-transition class="space-y-4">
                <!-- Origin type -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Origin</label>
                    <div class="flex gap-3">
                        <button type="button" @click="data.origin = 'internal'"
                                :class="data.origin === 'internal' ? 'bg-primary-100 text-primary-800 ring-primary-600 ring-1' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                class="rounded-full px-4 py-1.5 text-sm font-medium transition-colors">
                            Internal
                        </button>
                        <button type="button" @click="data.origin = 'external'"
                                :class="data.origin === 'external' ? 'bg-primary-100 text-primary-800 ring-primary-600 ring-1' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                class="rounded-full px-4 py-1.5 text-sm font-medium transition-colors">
                            External / Gift
                        </button>
                    </div>
                </div>

                <!-- External source name -->
                <div x-show="data.origin === 'external'">
                    <label class="block text-sm font-medium text-gray-700">Source</label>
                    <input type="text" x-model="data.external_source"
                           placeholder="e.g., Dr. Smith Lab, University of..."
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm px-3 py-2 border">
                </div>

                <!-- Genotype -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Genotype *</label>
                    <textarea x-model="data.genotype" rows="3" required
                              placeholder="Enter full genotype string"
                              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm px-3 py-2 border"></textarea>
                </div>
            </div>
        </div>

        <!-- Step 1 Navigation -->
        <div class="flex justify-between mt-6">
            <a href="/stocks" class="inline-flex items-center rounded-md bg-white px-4 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                Cancel
            </a>
            <button type="button" @click="nextStep()"
                    :disabled="!canProceedStep1()"
                    class="inline-flex items-center rounded-md bg-primary-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500 disabled:opacity-50 disabled:cursor-not-allowed">
                Next
                <svg class="ml-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Step 2: Identity & Shortname -->
    <div x-show="step === 2" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 translate-x-4" x-transition:enter-end="opacity-100 translate-x-0">
        <div class="bg-white shadow rounded-lg p-6 space-y-5">
            <h2 class="text-lg font-medium text-gray-900">Identity & Description</h2>

            <!-- Genotype summary -->
            <div class="bg-gray-50 rounded-md p-3">
                <p class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Genotype</p>
                <p class="text-sm text-gray-900 font-mono" x-text="data.genotype"></p>
            </div>

            <!-- Stock ID -->
            <div>
                <label class="block text-sm font-medium text-gray-700">Stock ID *</label>
                <input type="text" x-model="data.stock_id" required
                       placeholder="e.g., BL-80563"
                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm px-3 py-2 border">
                <p class="mt-1 text-xs text-gray-500">Unique identifier for this stock in your lab</p>
            </div>

            <!-- Shortname -->
            <div>
                <label class="block text-sm font-medium text-gray-700">Short Name</label>
                <div class="mt-1 flex gap-2">
                    <input type="text" x-model="data.shortname"
                           placeholder="e.g., GFP membrane marker"
                           class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm px-3 py-2 border">
                    <button type="button" @click="suggestShortname()"
                            :disabled="suggestingShortname || !data.genotype"
                            class="inline-flex items-center whitespace-nowrap rounded-md bg-indigo-50 px-3 py-2 text-sm font-medium text-indigo-700 ring-1 ring-inset ring-indigo-200 hover:bg-indigo-100 disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg x-show="suggestingShortname" class="animate-spin h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span x-text="suggestingShortname ? 'Suggesting...' : 'Suggest'"></span>
                    </button>
                </div>
                <p class="mt-1 text-xs text-gray-500">Short human-readable phenotype summary (2-5 words)</p>
            </div>

            <!-- Notes -->
            <div>
                <label class="block text-sm font-medium text-gray-700">Notes</label>
                <textarea x-model="data.notes" rows="2"
                          placeholder="Additional information about this stock"
                          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm px-3 py-2 border"></textarea>
            </div>
        </div>

        <!-- Step 2 Navigation -->
        <div class="flex justify-between mt-6">
            <button type="button" @click="prevStep()"
                    class="inline-flex items-center rounded-md bg-white px-4 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                <svg class="mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                Back
            </button>
            <button type="button" @click="nextStep()"
                    :disabled="!canProceedStep2()"
                    class="inline-flex items-center rounded-md bg-primary-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500 disabled:opacity-50 disabled:cursor-not-allowed">
                Next
                <svg class="ml-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Step 3: Location -->
    <div x-show="step === 3" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 translate-x-4" x-transition:enter-end="opacity-100 translate-x-0">
        <div class="bg-white shadow rounded-lg p-6 space-y-5">
            <h2 class="text-lg font-medium text-gray-900">Location</h2>
            <p class="text-sm text-gray-500">Assign this stock to a tray and position. You can skip this and assign a location later.</p>

            <!-- Tray Selection -->
            <div>
                <label class="block text-sm font-medium text-gray-700">Tray</label>
                <select x-model="data.tray_id" @change="data.position = ''"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm px-3 py-2 border">
                    <option value="">No tray (skip)</option>
                    <template x-for="tray in trays" :key="tray.id">
                        <option :value="tray.id" x-text="tray.name + ' (' + tray.tray_type + ', ' + tray.capacity + ' slots)'"></option>
                    </template>
                </select>
            </div>

            <!-- Position -->
            <div x-show="data.tray_id">
                <label class="block text-sm font-medium text-gray-700">Position</label>
                <input type="text" x-model="data.position"
                       :placeholder="getPositionPlaceholder()"
                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm px-3 py-2 border">
                <p class="mt-1 text-xs text-gray-500" x-text="getPositionHint()"></p>
            </div>
        </div>

        <!-- Step 3 Navigation -->
        <div class="flex justify-between mt-6">
            <button type="button" @click="prevStep()"
                    class="inline-flex items-center rounded-md bg-white px-4 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                <svg class="mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                Back
            </button>
            <button type="button" @click="nextStep()"
                    class="inline-flex items-center rounded-md bg-primary-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500 disabled:opacity-50 disabled:cursor-not-allowed">
                Review
                <svg class="ml-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Step 4: Review & Submit -->
    <div x-show="step === 4" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 translate-x-4" x-transition:enter-end="opacity-100 translate-x-0">
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-lg font-medium text-gray-900 mb-4">Review & Submit</h2>

            <dl class="divide-y divide-gray-200">
                <!-- Stock ID -->
                <div class="py-3 sm:grid sm:grid-cols-3 sm:gap-4">
                    <dt class="text-sm font-medium text-gray-500">Stock ID</dt>
                    <dd class="mt-1 text-sm text-gray-900 sm:col-span-2 sm:mt-0 font-medium" x-text="data.stock_id"></dd>
                </div>

                <!-- Origin -->
                <div class="py-3 sm:grid sm:grid-cols-3 sm:gap-4">
                    <dt class="text-sm font-medium text-gray-500">Origin</dt>
                    <dd class="mt-1 text-sm text-gray-900 sm:col-span-2 sm:mt-0">
                        <span x-show="data.origin === 'repository'">
                            <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-800" x-text="data.repository?.toUpperCase()"></span>
                            <span class="ml-1" x-text="'#' + data.repository_stock_id"></span>
                        </span>
                        <span x-show="data.origin === 'internal'" class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium bg-green-100 text-green-800">Internal</span>
                        <span x-show="data.origin === 'external'">
                            <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium bg-yellow-100 text-yellow-800">External</span>
                            <span x-show="data.external_source" class="ml-1 text-gray-600" x-text="data.external_source"></span>
                        </span>
                    </dd>
                </div>

                <!-- Genotype -->
                <div class="py-3 sm:grid sm:grid-cols-3 sm:gap-4">
                    <dt class="text-sm font-medium text-gray-500">Genotype</dt>
                    <dd class="mt-1 text-sm text-gray-900 sm:col-span-2 sm:mt-0 font-mono break-all" x-text="data.genotype"></dd>
                </div>

                <!-- Original genotype (if modified) -->
                <div x-show="data.original_genotype && data.original_genotype !== data.genotype" class="py-3 sm:grid sm:grid-cols-3 sm:gap-4">
                    <dt class="text-sm font-medium text-gray-500">Original Genotype</dt>
                    <dd class="mt-1 text-sm text-gray-500 sm:col-span-2 sm:mt-0 font-mono break-all" x-text="data.original_genotype"></dd>
                </div>

                <!-- Shortname -->
                <div x-show="data.shortname" class="py-3 sm:grid sm:grid-cols-3 sm:gap-4">
                    <dt class="text-sm font-medium text-gray-500">Short Name</dt>
                    <dd class="mt-1 text-sm text-gray-900 sm:col-span-2 sm:mt-0" x-text="data.shortname"></dd>
                </div>

                <!-- Location -->
                <div class="py-3 sm:grid sm:grid-cols-3 sm:gap-4">
                    <dt class="text-sm font-medium text-gray-500">Location</dt>
                    <dd class="mt-1 text-sm sm:col-span-2 sm:mt-0">
                        <span x-show="data.tray_id" class="text-gray-900">
                            <span x-text="getTrayName(data.tray_id)"></span>
                            <span x-show="data.position" class="text-gray-500"> &mdash; Position <span x-text="data.position"></span></span>
                        </span>
                        <span x-show="!data.tray_id" class="text-gray-400 italic">Not assigned</span>
                    </dd>
                </div>

                <!-- Notes -->
                <div x-show="data.notes" class="py-3 sm:grid sm:grid-cols-3 sm:gap-4">
                    <dt class="text-sm font-medium text-gray-500">Notes</dt>
                    <dd class="mt-1 text-sm text-gray-900 sm:col-span-2 sm:mt-0" x-text="data.notes"></dd>
                </div>
            </dl>
        </div>

        <!-- Step 4 Navigation -->
        <div class="flex justify-between mt-6">
            <button type="button" @click="prevStep()"
                    class="inline-flex items-center rounded-md bg-white px-4 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                <svg class="mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                Back
            </button>
            <button type="button" @click="submitStock()"
                    :disabled="submitting"
                    class="inline-flex items-center rounded-md bg-green-600 px-5 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-500 disabled:opacity-50 disabled:cursor-not-allowed">
                <svg x-show="submitting" class="animate-spin h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span x-text="submitting ? 'Creating...' : 'Create Stock'"></span>
            </button>
        </div>
    </div>
</div>

<script>
function stockWizard() {
    return {
        step: 1,
        steps: ['Origin', 'Identity', 'Location', 'Review'],
        fromRepository: null,
        searchQuery: '',
        searching: false,
        searchResults: null,
        selectedResult: null,
        selectedRepository: null,
        genotypeModified: false,
        suggestingShortname: false,
        submitting: false,
        stats: null,
        trays: [],

        data: {
            stock_id: '',
            genotype: '',
            shortname: '',
            origin: 'internal',
            repository: null,
            repository_stock_id: null,
            external_source: '',
            original_genotype: null,
            notes: '',
            tray_id: '',
            position: '',
        },

        repositoryNames: {
            'bdsc': 'Bloomington (BDSC)',
            'vdrc': 'Vienna (VDRC)',
            'kyoto': 'Kyoto',
            'nig': 'NIG-Fly',
            'kdrc': 'KDRC',
            'flyorf': 'FlyORF',
            'ndssc': 'NDSSC'
        },

        repositoryPrefixes: {
            'bdsc': 'BL',
            'vdrc': 'VDRC',
            'kyoto': 'KY',
            'nig': 'NIG',
            'kdrc': 'KDRC',
            'flyorf': 'FORF',
            'ndssc': 'NDSSC'
        },

        getRepositoryName(repoId) {
            return this.repositoryNames[repoId] || repoId?.toUpperCase() || '';
        },

        setFromRepository(value) {
            this.fromRepository = value;
            if (value) {
                this.data.origin = 'repository';
            } else {
                this.data.origin = 'internal';
                this.data.repository = null;
                this.data.repository_stock_id = null;
                this.data.original_genotype = null;
                this.selectedResult = null;
                this.searchResults = null;
            }
        },

        async loadStats() {
            try {
                const response = await fetch('/api/plugins/sources/flybase/stats', {
                    credentials: 'include'
                });
                if (response.ok) {
                    this.stats = await response.json();
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }

            // Also load trays
            try {
                const response = await fetch('/api/trays?page_size=100', {
                    credentials: 'include'
                });
                if (response.ok) {
                    const result = await response.json();
                    this.trays = result.items || result;
                }
            } catch (error) {
                console.error('Error loading trays:', error);
            }
        },

        async searchFlyBase() {
            if (!this.searchQuery.trim() || !this.selectedRepository) return;

            this.searching = true;
            this.searchResults = null;
            this.selectedResult = null;

            try {
                const params = new URLSearchParams({
                    query: this.searchQuery.trim(),
                    source: 'flybase',
                    repository: this.selectedRepository,
                    limit: '20'
                });

                const response = await fetch('/api/plugins/search?' + params.toString(), {
                    credentials: 'include'
                });

                if (response.ok) {
                    this.searchResults = await response.json();
                } else {
                    const error = await response.json();
                    this.showMessage(error.detail || 'Search failed', 'error');
                }
            } catch (error) {
                console.error('Search error:', error);
                this.showMessage('An error occurred during search.', 'error');
            } finally {
                this.searching = false;
            }
        },

        selectFlyBaseResult(result) {
            this.selectedResult = result;
            this.data.genotype = result.genotype;
            this.data.original_genotype = result.genotype;
            this.data.repository = result.source;
            this.data.repository_stock_id = result.external_id;
            this.genotypeModified = false;

            // Auto-suggest stock_id
            const prefix = this.repositoryPrefixes[result.source] || result.source.toUpperCase();
            this.data.stock_id = prefix + '-' + result.external_id;
        },

        clearSelection() {
            this.selectedResult = null;
            this.data.genotype = '';
            this.data.original_genotype = null;
            this.data.repository = null;
            this.data.repository_stock_id = null;
            this.data.stock_id = '';
            this.genotypeModified = false;
        },

        canProceedStep1() {
            if (this.fromRepository === null) return false;
            if (this.fromRepository) {
                return this.selectedResult !== null;
            }
            return this.data.genotype.trim().length > 0;
        },

        canProceedStep2() {
            return this.data.stock_id.trim().length > 0;
        },

        nextStep() {
            if (this.step === 1 && !this.canProceedStep1()) return;
            if (this.step === 2 && !this.canProceedStep2()) return;

            // When leaving step 1 with modified genotype, store original
            if (this.step === 1 && this.fromRepository && this.genotypeModified) {
                this.data.original_genotype = this.selectedResult?.genotype || null;
            } else if (this.step === 1 && this.fromRepository && !this.genotypeModified) {
                this.data.original_genotype = null;
            }

            this.step++;
        },

        prevStep() {
            if (this.step > 1) this.step--;
        },

        async suggestShortname() {
            if (!this.data.genotype) return;
            this.suggestingShortname = true;
            try {
                const response = await fetch('/api/stocks/suggest-shortname', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ genotype: this.data.genotype })
                });
                if (response.ok) {
                    const result = await response.json();
                    this.data.shortname = result.shortname;
                } else {
                    const error = await response.json();
                    this.showMessage(error.detail || 'Failed to suggest shortname', 'error');
                }
            } catch (error) {
                console.error('Error suggesting shortname:', error);
                this.showMessage('Failed to suggest shortname', 'error');
            } finally {
                this.suggestingShortname = false;
            }
        },

        getPositionPlaceholder() {
            const tray = this.trays.find(t => t.id === this.data.tray_id);
            if (!tray) return 'e.g., A1';
            return 'e.g., A1';
        },

        getPositionHint() {
            const tray = this.trays.find(t => t.id === this.data.tray_id);
            if (!tray) return '';
            return `${tray.name}: ${tray.tray_type} with ${tray.capacity} slots`;
        },

        getTrayName(trayId) {
            const tray = this.trays.find(t => t.id === trayId);
            return tray ? tray.name : '';
        },

        showMessage(text, type) {
            const el = document.getElementById('wizard-message');
            const bgClass = type === 'error' ? 'bg-red-50' : 'bg-green-50';
            const textClass = type === 'error' ? 'text-red-700' : 'text-green-700';
            el.innerHTML = `
                <div class="mb-4 rounded-md ${bgClass} p-4">
                    <p class="text-sm ${textClass}">${text}</p>
                </div>`;
            // Auto-clear after 5 seconds
            setTimeout(() => { el.innerHTML = ''; }, 5000);
        },

        async submitStock() {
            this.submitting = true;

            const payload = {
                stock_id: this.data.stock_id,
                genotype: this.data.genotype,
                origin: this.data.origin,
            };

            // Optional fields
            if (this.data.shortname) payload.shortname = this.data.shortname;
            if (this.data.notes) payload.notes = this.data.notes;
            if (this.data.tray_id) payload.tray_id = this.data.tray_id;
            if (this.data.position) payload.position = this.data.position;

            // Repository fields
            if (this.data.origin === 'repository') {
                payload.repository = this.data.repository;
                payload.repository_stock_id = this.data.repository_stock_id;
                if (this.data.original_genotype && this.data.original_genotype !== this.data.genotype) {
                    payload.original_genotype = this.data.original_genotype;
                }
            }

            // External source
            if (this.data.origin === 'external' && this.data.external_source) {
                payload.external_source = this.data.external_source;
            }

            try {
                const response = await fetch('/api/stocks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok) {
                    window.location.href = '/stocks/' + result.id;
                } else {
                    this.showMessage(result.detail || 'Failed to create stock', 'error');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            } catch (error) {
                console.error('Error:', error);
                this.showMessage('An error occurred. Please try again.', 'error');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } finally {
                this.submitting = false;
            }
        }
    }
}
</script>
{% endblock %}
