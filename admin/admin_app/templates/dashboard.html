{% extends "base.html" %}
{% set active_page = "dashboard" %}
{% block title %}Dashboard{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
{% endblock %}

{% block content %}
<!-- KPI Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
    <div class="bg-white rounded-lg shadow p-5">
        <p class="text-sm text-gray-500">Total Tenants</p>
        <p class="text-3xl font-bold text-gray-900 mt-1">{{ overview.tenants_total }}</p>
        <p class="text-xs text-green-600 mt-1">{{ overview.tenants_active }} active</p>
    </div>
    <div class="bg-white rounded-lg shadow p-5">
        <p class="text-sm text-gray-500">Total Users</p>
        <p class="text-3xl font-bold text-gray-900 mt-1">{{ overview.users_total }}</p>
        <p class="text-xs text-green-600 mt-1">{{ overview.users_active }} active</p>
    </div>
    <div class="bg-white rounded-lg shadow p-5">
        <p class="text-sm text-gray-500">Total Stocks</p>
        <p class="text-3xl font-bold text-gray-900 mt-1">{{ overview.stocks_total }}</p>
    </div>
    <div class="bg-white rounded-lg shadow p-5">
        <p class="text-sm text-gray-500">Total Crosses</p>
        <p class="text-3xl font-bold text-gray-900 mt-1">{{ overview.crosses_total }}</p>
        <p class="text-xs text-gray-400 mt-1">{{ overview.organizations_total }} organizations</p>
    </div>
</div>

<!-- Charts Row 1 -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <div class="bg-white rounded-lg shadow p-5">
        <h3 class="text-sm font-semibold text-gray-700 mb-3">Plan Distribution</h3>
        <canvas id="planChart" height="200"></canvas>
    </div>
    <div class="bg-white rounded-lg shadow p-5">
        <h3 class="text-sm font-semibold text-gray-700 mb-3">Subscription Status</h3>
        <canvas id="subChart" height="200"></canvas>
    </div>
</div>

<!-- Charts Row 2 -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="bg-white rounded-lg shadow p-5">
        <h3 class="text-sm font-semibold text-gray-700 mb-3">Growth Over Time</h3>
        <canvas id="growthChart" height="200"></canvas>
    </div>
    <div class="bg-white rounded-lg shadow p-5">
        <h3 class="text-sm font-semibold text-gray-700 mb-3">Top Tenants by Stocks</h3>
        <canvas id="topTenantsChart" height="200"></canvas>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const COLORS = {
    amber: 'rgb(245, 158, 11)',
    orange: 'rgb(249, 115, 22)',
    yellow: 'rgb(234, 179, 8)',
    emerald: 'rgb(16, 185, 129)',
    blue: 'rgb(59, 130, 246)',
    purple: 'rgb(139, 92, 246)',
    red: 'rgb(239, 68, 68)',
    gray: 'rgb(107, 114, 128)',
};

const PIE_COLORS = [COLORS.amber, COLORS.emerald, COLORS.blue, COLORS.purple, COLORS.red, COLORS.gray];

async function loadCharts() {
    // Plan distribution
    const planData = await fetch('/api/stats/plan-distribution').then(r => r.json());
    new Chart(document.getElementById('planChart'), {
        type: 'pie',
        data: {
            labels: planData.map(d => d.plan.toUpperCase()),
            datasets: [{ data: planData.map(d => d.count), backgroundColor: PIE_COLORS }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });

    // Subscription status
    const subData = await fetch('/api/stats/subscription-status').then(r => r.json());
    new Chart(document.getElementById('subChart'), {
        type: 'doughnut',
        data: {
            labels: subData.map(d => d.status.toUpperCase()),
            datasets: [{ data: subData.map(d => d.count), backgroundColor: PIE_COLORS }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });

    // Growth
    const growthData = await fetch('/api/stats/growth').then(r => r.json());
    const allMonths = [...new Set([
        ...growthData.tenants.map(d => d.month),
        ...growthData.users.map(d => d.month)
    ])].sort();
    const tenantMap = Object.fromEntries(growthData.tenants.map(d => [d.month, d.count]));
    const userMap = Object.fromEntries(growthData.users.map(d => [d.month, d.count]));
    new Chart(document.getElementById('growthChart'), {
        type: 'line',
        data: {
            labels: allMonths,
            datasets: [
                { label: 'Tenants', data: allMonths.map(m => tenantMap[m] || 0), borderColor: COLORS.amber, tension: 0.3 },
                { label: 'Users', data: allMonths.map(m => userMap[m] || 0), borderColor: COLORS.blue, tension: 0.3 },
            ]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } }, scales: { y: { beginAtZero: true } } }
    });

    // Top tenants
    const topData = await fetch('/api/stats/top-tenants').then(r => r.json());
    new Chart(document.getElementById('topTenantsChart'), {
        type: 'bar',
        data: {
            labels: topData.map(d => d.name.length > 20 ? d.name.slice(0, 20) + '...' : d.name),
            datasets: [{ label: 'Stocks', data: topData.map(d => d.stock_count), backgroundColor: COLORS.amber }]
        },
        options: { responsive: true, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true } } }
    });
}

loadCharts();
</script>
{% endblock %}
